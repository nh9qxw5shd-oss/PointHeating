<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Winter Points Logbook</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 0;
      color: #111827;
    }

    header {
      background: #111827;
      color: #f9fafb;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      font-size: 1.2rem;
      margin: 0;
    }

    header .env {
      font-size: 0.8rem;
      opacity: 0.8;
    }

    
    header .header-actions{
      display:flex;
      align-items:center;
      gap:0.75rem;
    }

    /* Simple modal (idiot-proofing) */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(17,24,39,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 9999;
    }
    .modal{
      background:#ffffff;
      color:#111827;
      border-radius:0.75rem;
      box-shadow: 0 20px 50px rgba(0,0,0,0.25);
      max-width: 520px;
      width: 100%;
      padding: 1rem;
    }
    .modal h2{
      font-size: 1rem;
      margin: 0 0 0.5rem 0;
      color:#111827;
    }
    .modal p{
      font-size: 0.9rem;
      color:#374151;
      margin: 0 0 0.75rem 0;
      line-height: 1.35;
    }
    .modal .modal-actions{
      display:flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: flex-end;
    }

    .guide{
      background:#ffffff;
      border-radius:0.75rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.05);
      padding: 0.9rem 1rem;
      margin-bottom: 0.75rem;
      border-left: 4px solid #111827;
    }
    .guide h3{
      margin:0 0 0.35rem 0;
      font-size:0.95rem;
      color:#111827;
    }
    .guide ul{
      margin:0.35rem 0 0 1.1rem;
      padding:0;
      font-size:0.85rem;
      color:#374151;
    }
    .hidden{ display:none !important; }
main {
      padding: 1.5rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
      align-items: center;
    }

    .controls label {
      font-size: 0.9rem;
      font-weight: 600;
      color: #374151;
    }

    .controls select {
      padding: 0.3rem 0.5rem;
      border-radius: 0.375rem;
      border: 1px solid #d1d5db;
      background: #ffffff;
      font-size: 0.9rem;
    }

    .controls .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      font-size: 0.8rem;
      margin-left: auto;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    /* Make status contents align like normal text */
.status-wrap {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  line-height: 1;
}

/* Force dot to sit dead-centre, not baseline-wobble */
.status-dot {
  display: inline-block;
  width: 10px;
  height: 10px;
  border-radius: 999px;
  flex: 0 0 10px;
}

    .green { background-color: #10b981; }
    .amber { background-color: #f59e0b; }
    .red   { background-color: #ef4444; }
    .grey  { background-color: #9ca3af; }

    .card {
      background: #ffffff;
      border-radius: 0.75rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
      padding: 1rem;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    thead {
      background: #f9fafb;
    }

    th, td {
      padding: 0.5rem 0.6rem;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: middle;
      white-space: nowrap;
    }

    th {
      font-weight: 600;
      color: #4b5563;
      position: sticky;
      top: 0;
      background: #f9fafb;
      z-index: 1;
    }

    td.notes {
      white-space: normal;
      max-width: 300px;
    }

    .status-cell {
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }

    .status-text {
      font-size: 0.8rem;
      color: #4b5563;
    }

    .btn {
      padding: 0.3rem 0.6rem;
      border-radius: 0.375rem;
      border: none;
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .btn-primary {
      background-color: #111827;
      color: #f9fafb;
    }

    .btn-primary:disabled {
      background-color: #6b7280;
      cursor: default;
    }

    .btn-secondary {
      background-color: #e5e7eb;
      color: #374151;
    }

    .btn-danger {
      background-color: #ef4444;
      color: #f9fafb;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #e5e7eb;
      color: #374151;
    }

    .meta-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      font-size: 0.8rem;
      color: #6b7280;
    }

    .error-banner {
      background: #fee2e2;
      color: #991b1b;
      border-radius: 0.5rem;
      padding: 0.5rem 0.75rem;
      margin-bottom: 0.75rem;
      font-size: 0.8rem;
      display: none;
    }

    .loading {
      font-size: 0.85rem;
      color: #6b7280;
      margin-bottom: 0.5rem;
    }

    .add-form {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      align-items: flex-end;
      font-size: 0.8rem;
    }

    .add-form-group {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .add-form-group label {
      font-weight: 600;
      color: #374151;
    }

    .add-form-group input {
      padding: 0.3rem 0.4rem;
      border-radius: 0.375rem;
      border: 1px solid #d1d5db;
      font-size: 0.8rem;
      min-width: 140px;
    }

    .add-form-group select {
      padding: 0.3rem 0.4rem;
      border-radius: 0.375rem;
      border: 1px solid #d1d5db;
      background: #ffffff;
      font-size: 0.8rem;
      min-width: 140px;
    }


    @media (max-width: 640px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
      }
      .controls {
        flex-direction: column;
        align-items: flex-start;
      }
      .controls .legend {
        margin-left: 0;
      }
      .add-form {
        flex-direction: column;
        align-items: stretch;
      }
      .add-form-group input {
        min-width: 0;
      }
    }
  </style>
</head>
<body>
<header>
  <h1>Winter Points Logbook</h1>
  <div class="header-actions">
    <button type="button" id="managePointsBtn" class="btn btn-secondary">Add / Edit New Point +</button>
    <div class="env">GitHub / Supabase · Killfrost tracker</div>
  </div>
</header>

<main>
  <div class="controls">
    <div>
      <label for="areaSelect">MOM area:</label>
      <select id="areaSelect">
        <option value="ALL">All areas</option>
        <!-- dynamic options -->
      </select>
    </div>

    <div class="legend">
      <span class="legend-item">
        <span class="status-dot green"></span> &lt; 24h
      </span>
      <span class="legend-item">
        <span class="status-dot amber"></span> 24–48h
      </span>
      <span class="legend-item">
        <span class="status-dot red"></span> &gt; 48h
      </span>
      <span class="legend-item">
        <span class="status-dot grey"></span> Not treated
      </span>
    </div>
  </div>

  <div class="meta-row">
    <div id="summaryText">Loading points…</div>
    <div>Now: <span id="clock"></span></div>
  </div>

  
  <!-- User guide (idiot-proofed) -->
  <div class="guide" id="userGuide">
    <h3>How to use this logbook</h3>
    <ul>
      <li><strong>Recording treatment:</strong> find the point you treated in the table and click <strong>Treat now</strong>. Nothing else required.</li>
      <li><strong>Editing details:</strong> use <strong>Add / Edit New Point +</strong> in the header. Do <em>not</em> re-add a point to update notes.</li>
      <li><strong>Adding a brand new point:</strong> also via <strong>Add / Edit New Point +</strong> (only when it truly doesn’t exist yet).</li>
    </ul>
  </div>

  <!-- Add / Edit UI (kept out of the way) -->
  <div id="managePanel" class="card hidden" style="margin-bottom:0.75rem;">
    <div id="addNewPanel" class="hidden">
      <div class="meta-row" style="margin-bottom:0.5rem;">
        <div><strong>Add new point set</strong></div>
        <div class="badge">New</div>
      </div>
      <form id="addNewForm" class="add-form">
        <div class="add-form-group">
          <label for="addArea">Area</label>
          <select id="addArea" required>
            <option value="" disabled selected>Select area…</option>
            <option value="Derby">Derby</option>
            <option value="Nottingham">Nottingham</option>
            <option value="Leicester">Leicester</option>
            <option value="Kettering">Kettering</option>
            <option value="Lincoln">Lincoln</option>
            <option value="WH">WH</option>
          </select>
        </div>
        <div class="add-form-group">
          <label for="addPoint">Point</label>
          <input id="addPoint" type="text" placeholder="e.g. 123A" required />
        </div>
        <div class="add-form-group">
          <label for="addLocation">Location</label>
          <input id="addLocation" type="text" placeholder="e.g. West Jn" />
        </div>
        <div class="add-form-group">
          <label for="addNotes">Notes</label>
          <input id="addNotes" type="text" placeholder="Defective heater / none fitted" />
        </div>
        <button type="submit" class="btn btn-primary">Save new point</button>
        <button type="button" id="closeManageBtn1" class="btn btn-secondary">Close</button>
      </form>
    </div>

    <div id="editExistingPanel" class="hidden">
      <div class="meta-row" style="margin-bottom:0.5rem;">
        <div><strong>Edit existing point set</strong></div>
        <div class="badge">Edit</div>
      </div>
      <form id="editExistingForm" class="add-form">
        <div class="add-form-group" style="min-width:260px;">
          <label for="editSelect">Choose point</label>
          <select id="editSelect" required>
            <option value="" disabled selected>Select a point…</option>
          </select>
        </div>
        <div class="add-form-group">
          <label>Area</label>
          <input id="editArea" type="text" disabled />
        </div>
        <div class="add-form-group">
          <label>Point</label>
          <input id="editPoint" type="text" disabled />
        </div>
        <div class="add-form-group">
          <label for="editLocation">Location</label>
          <input id="editLocation" type="text" />
        </div>
        <div class="add-form-group">
          <label for="editNotes">Notes</label>
          <input id="editNotes" type="text" />
        </div>
        <button type="submit" class="btn btn-primary">Save changes</button>
        <button type="button" id="closeManageBtn2" class="btn btn-secondary">Close</button>
      </form>
    </div>
  </div>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h2 id="modalTitle">Add / Edit New Point</h2>
      <p id="modalBody"></p>
      <div class="modal-actions" id="modalActions"></div>
    </div>
  </div>


  <div id="errorBanner" class="error-banner"></div>

  <div class="card">
    <div id="loading" class="loading">Connecting to Supabase…</div>
    <table id="pointsTable">
      <thead>
        <tr>
          <th>Area</th>
          <th>Point</th>
          <th>Location</th>
          <th>Notes</th>
          <th>Last treated</th>
          <th>Hours since</th>
          <th>Status</th>
          <th>Treat</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody>
        <!-- populated by JS -->
      </tbody>
    </table>
  </div>
</main>

<!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ===== CONFIG: FILL THESE IN =====
  const SUPABASE_URL  = "https://ungtmfwxqawkdiflmora.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVuZ3RtZnd4cWF3a2RpZmxtb3JhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMDY4NjQsImV4cCI6MjA3NzY4Mjg2NH0.Yaq0XfbbkwxJDUoiPCS7bLVBy70Wa-NOOWIxkpRRxdc";

  // Table name in Supabase
  const TABLE_NAME = "points_winter_log";

  // RAG thresholds (hours)
  const GREEN_LIMIT_HOURS = 24;
  const AMBER_LIMIT_HOURS = 48;

  // Allowed MOM areas (used for entry + filter)
  const AREAS = ["Derby","Nottingham","Leicester","Kettering","Lincoln","WH"];


  // ===== Supabase client =====
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ===== UI state =====
  let allPoints = []; // rows from Supabase
  let currentAreaFilter = "ALL";
  let isSaving = false;

  const areaSelect   = document.getElementById("areaSelect");
  const pointsTable  = document.getElementById("pointsTable").querySelector("tbody");
  const summaryText  = document.getElementById("summaryText");
  const clockEl      = document.getElementById("clock");
  const errorBanner  = document.getElementById("errorBanner");
  const loadingEl    = document.getElementById("loading");
  const managePointsBtn = document.getElementById("managePointsBtn");
  const managePanel     = document.getElementById("managePanel");
  const addNewPanel     = document.getElementById("addNewPanel");
  const editExistingPanel = document.getElementById("editExistingPanel");

  const addNewForm      = document.getElementById("addNewForm");
  const addAreaInput    = document.getElementById("addArea");
  const addPointInput   = document.getElementById("addPoint");
  const addLocationInput= document.getElementById("addLocation");
  const addNotesInput   = document.getElementById("addNotes");
  const closeManageBtn1 = document.getElementById("closeManageBtn1");

  const editExistingForm = document.getElementById("editExistingForm");
  const editSelect       = document.getElementById("editSelect");
  const editAreaEl       = document.getElementById("editArea");
  const editPointEl      = document.getElementById("editPoint");
  const editLocationInput= document.getElementById("editLocation");
  const editNotesInput   = document.getElementById("editNotes");
  const closeManageBtn2  = document.getElementById("closeManageBtn2");

  const modalBackdrop   = document.getElementById("modalBackdrop");
  const modalTitle      = document.getElementById("modalTitle");
  const modalBody       = document.getElementById("modalBody");
  const modalActions    = document.getElementById("modalActions");

  // ===== Clock =====
  function updateClock() {
    const now = new Date();
    const pad = (n) => n.toString().padStart(2, "0");
    const ts = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} `
      + `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
    clockEl.textContent = ts;
  }
  setInterval(updateClock, 1000);
  updateClock();

  // ===== Helpers =====
  function diffHoursFromNow(isoString) {
    if (!isoString) return null;
    const t = new Date(isoString).getTime();
    if (Number.isNaN(t)) return null;
    const diffMs = Date.now() - t;
    return diffMs / (1000 * 60 * 60);
  }

  function ragStatus(isoString) {
    const hours = diffHoursFromNow(isoString);
    if (hours === null) {
      return {
        className: "grey",
        label: "Not treated",
        hoursText: "-"
      };
    }

    const rounded = Math.floor(hours);
    let className;
    if (hours < GREEN_LIMIT_HOURS) {
      className = "green";
    } else if (hours < AMBER_LIMIT_HOURS) {
      className = "amber";
    } else {
      className = "red";
    }

    return {
      className,
      label: `${rounded}h`,
      hoursText: `${rounded}`
    };
  }

  function groupAreas(rows) {
    const set = new Set();
    rows.forEach(r => {
      if (r.area) set.add(r.area);
    });
    return Array.from(set).sort();
  }

  function showError(msg) {
    errorBanner.textContent = msg;
    errorBanner.style.display = "block";
  }

  function clearError() {
    errorBanner.textContent = "";
    errorBanner.style.display = "none";
  }

  // ===== Rendering =====
  function renderAreaOptions() {
    // Use the fixed allowed area list (plus ALL)
    const areas = AREAS.slice();

    // reset except "ALL"
    while (areaSelect.options.length > 1) {
      areaSelect.remove(1);
    }

    areas.forEach(area => {
      const opt = document.createElement("option");
      opt.value = area;
      opt.textContent = area;
      areaSelect.appendChild(opt);
    });

    // keep filter if it still exists, else reset to ALL
    const currentExists = areas.includes(currentAreaFilter);
    if (!currentExists && currentAreaFilter !== "ALL") {
      currentAreaFilter = "ALL";
      areaSelect.value = "ALL";
    } else {
      areaSelect.value = currentAreaFilter;
    }
  }


  function getFilteredRows() {
    if (currentAreaFilter === "ALL") return allPoints;
    return allPoints.filter(r => r.area === currentAreaFilter);
  }

  function renderTable() {
    const rows = getFilteredRows();
    pointsTable.innerHTML = "";

    if (!rows.length) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 10;
      td.textContent = "No points found for this filter.";
      td.style.textAlign = "center";
      td.style.padding = "1rem";
      tr.appendChild(td);
      pointsTable.appendChild(tr);
    } else {
      rows.forEach(row => {
        const status = ragStatus(row.last_treated_at);

        const tr = document.createElement("tr");

        const tdArea = document.createElement("td");
        tdArea.textContent = row.area;

        const tdPoint = document.createElement("td");
        tdPoint.innerHTML = `<span class="badge">${row.point_number || "?"}</span>`;

        const tdLocation = document.createElement("td");
        tdLocation.textContent = row.location || "";

        const tdNotes = document.createElement("td");
        tdNotes.textContent = row.notes || "";
        tdNotes.classList.add("notes");

        const tdLast = document.createElement("td");
        tdLast.textContent = row.last_treated_at
          ? new Date(row.last_treated_at).toLocaleString()
          : "-";

        const tdHours = document.createElement("td");
        tdHours.textContent = status.hoursText;

        const tdStatus = document.createElement("td");

const statusWrap = document.createElement("span");
statusWrap.classList.add("status-wrap");

const dot = document.createElement("span");
dot.classList.add("status-dot", status.className);

const txt = document.createElement("span");
txt.classList.add("status-text");
txt.textContent = status.label;

statusWrap.appendChild(dot);
statusWrap.appendChild(txt);
tdStatus.appendChild(statusWrap);

        const tdAction = document.createElement("td");
        const btnTreat = document.createElement("button");
        btnTreat.classList.add("btn", "btn-primary");
        btnTreat.textContent = "Treat now";
        btnTreat.disabled = isSaving;
        btnTreat.addEventListener("click", () => onTreatNow(row));
        tdAction.appendChild(btnTreat);


        const tdDelete = document.createElement("td");
        const btnDel = document.createElement("button");
        btnDel.classList.add("btn", "btn-danger");
        btnDel.textContent = "Delete";
        btnDel.disabled = isSaving;
        btnDel.addEventListener("click", () => onDelete(row));
        tdDelete.appendChild(btnDel);

        tr.appendChild(tdArea);
        tr.appendChild(tdPoint);
        tr.appendChild(tdLocation);
        tr.appendChild(tdNotes);
        tr.appendChild(tdLast);
        tr.appendChild(tdHours);
        tr.appendChild(tdStatus);
        tr.appendChild(tdAction);
tr.appendChild(tdDelete);

        pointsTable.appendChild(tr);
      });
    }

    summaryText.textContent = `${rows.length} points loaded${currentAreaFilter !== "ALL" ? ` · ${currentAreaFilter}` : ""}`;
  }

  // ===== Data loading =====
  async function loadData(silent = false) {
    if (!silent) {
      clearError();
      loadingEl.style.display = "block";
      loadingEl.textContent = "Loading points from Supabase…";
    }

    const { data, error } = await supabaseClient
      .from(TABLE_NAME)
      .select("*")
      .order("area", { ascending: true })
      .order("point_number", { ascending: true });

    if (error) {
      console.error(error);
      if (!silent) {
        loadingEl.textContent = "Failed to load data.";
        showError("Error loading data from Supabase. Check your URL / anon key / table name.");
      }
      return;
    }

    allPoints = data || [];
    renderAreaOptions();
    renderTable();

    if (!silent) {
      loadingEl.style.display = "none";
    }
  }

  // ===== Actions =====
  async function onTreatNow(row) {
    if (isSaving) return;

    clearError();
    isSaving = true;
    renderTable(); // disable buttons

    const nowIso = new Date().toISOString();

    const payload = {
      area: row.area,
      point_number: row.point_number,
      location: row.location,
      notes: row.notes,
      last_treated_at: nowIso
    };

    const { error } = await supabaseClient
      .from(TABLE_NAME)
      .upsert(payload, {
        onConflict: "area,point_number"
      });

    if (error) {
      console.error(error);
      showError("Failed to save treatment. Check Supabase permissions (RLS) and constraints.");
      isSaving = false;
      renderTable();
      return;
    }

    // Refresh from source of truth
    await loadData();
    isSaving = false;
    renderTable();
  }


 async function onDelete(row) {
  if (isSaving) return;

  const confirmed = window.confirm(
    `Are you sure you want to delete point ${row.point_number} in ${row.area}?\n\nThis cannot be undone.`
  );
  if (!confirmed) return;

  clearError();
  isSaving = true;
  renderTable();

  const { error } = await supabaseClient
    .from(TABLE_NAME)
    .delete()
    .eq("area", row.area)
    .eq("point_number", row.point_number);

  if (error) {
    console.error(error);
    showError("Failed to delete point. Check Supabase permissions (RLS).");
    isSaving = false;
    renderTable();
    return;
  }

  allPoints = allPoints.filter(
    p => !(p.area === row.area && p.point_number === row.point_number)
  );

  renderAreaOptions();
  isSaving = false;
  renderTable();



}
  // ===== Manage points (idiot-proofing) =====
  function hideManagePanels(){
    addNewPanel.classList.add("hidden");
    editExistingPanel.classList.add("hidden");
    managePanel.classList.add("hidden");
  }

  function showManagePanel(panel){
    managePanel.classList.remove("hidden");
    addNewPanel.classList.add("hidden");
    editExistingPanel.classList.add("hidden");
    panel.classList.remove("hidden");
  }

  function openModal({title, body, actions}){
    modalTitle.textContent = title || "Message";
    modalBody.textContent  = body || "";
    modalActions.innerHTML = "";

    (actions || []).forEach(a => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = a.className || "btn btn-secondary";
      btn.textContent = a.label || "OK";
      btn.addEventListener("click", () => {
        if (typeof a.onClick === "function") a.onClick();
      });
      modalActions.appendChild(btn);
    });

    modalBackdrop.style.display = "flex";
  }

  function closeModal(){
    modalBackdrop.style.display = "none";
  }

  function buildEditSelectOptions(){
    // Preserve selection if possible
    const current = editSelect.value || "";

    // Clear
    while (editSelect.options.length > 0) editSelect.remove(0);
    const ph = document.createElement("option");
    ph.value = "";
    ph.disabled = true;
    ph.selected = true;
    ph.textContent = "Select a point…";
    editSelect.appendChild(ph);

    const rows = [...allPoints].sort((a,b) => {
      const aa = (a.area||"").localeCompare(b.area||"");
      if (aa !== 0) return aa;
      return (a.point_number||"").localeCompare(b.point_number||"");
    });

    rows.forEach(r => {
      const opt = document.createElement("option");
      opt.value = `${r.area}||${r.point_number}`;
      opt.textContent = `${r.area} · ${r.point_number}${r.location ? ` (${r.location})` : ""}`;
      editSelect.appendChild(opt);
    });

    // Restore selection if still present
    if (current && Array.from(editSelect.options).some(o => o.value === current)) {
      editSelect.value = current;
      onEditSelectChange();
    }
  }

  function onEditSelectChange(){
    const val = editSelect.value;
    if (!val) return;

    const [area, point_number] = val.split("||");
    const row = allPoints.find(r => r.area === area && String(r.point_number) === String(point_number));
    if (!row) return;

    editAreaEl.value = row.area || "";
    editPointEl.value = row.point_number || "";
    editLocationInput.value = row.location || "";
    editNotesInput.value = row.notes || "";
  }

  function openChooser(){
    hideManagePanels();
    openModal({
      title: "Add / Edit New Point",
      body: "Choose what you actually meant to do. (Treating is NOT adding.)",
      actions: [
        {
          label: "Yes, add new set",
          className: "btn btn-primary",
          onClick: () => {
            closeModal();
            // reset add form
            addAreaInput.value = "";
            addPointInput.value = "";
            addLocationInput.value = "";
            addNotesInput.value = "";
            showManagePanel(addNewPanel);
            managePanel.scrollIntoView({behavior:"smooth", block:"start"});
          }
        },
        {
          label: "Edit existing set",
          className: "btn btn-secondary",
          onClick: () => {
            closeModal();
            buildEditSelectOptions();
            // reset edit form fields until selection
            editSelect.value = "";
            editAreaEl.value = "";
            editPointEl.value = "";
            editLocationInput.value = "";
            editNotesInput.value = "";
            showManagePanel(editExistingPanel);
            managePanel.scrollIntoView({behavior:"smooth", block:"start"});
          }
        },
        {
          label: "Record Treatment",
          className: "btn btn-secondary",
          onClick: () => {
            closeModal();
            openModal({
              title: "Recording treatment",
              body: "To record treatment: find the point in the table below and click “Treat now”. No other action is required.",
              actions: [{ label:"Got it", className:"btn btn-primary", onClick: closeModal }]
            });
          }
        },
        { label: "Cancel", className: "btn btn-secondary", onClick: closeModal }
      ]
    });
  }

  // Close modal on backdrop click (but not when clicking the modal itself)
  modalBackdrop.addEventListener("click", (e) => {
    if (e.target === modalBackdrop) closeModal();
  });

  // Add new point (brand new only)
  async function onAddNew(event){
    event.preventDefault();
    if (isSaving) return;

    clearError();

    const area = (addAreaInput.value || "").trim();
    const point_number = (addPointInput.value || "").trim();
    const location = (addLocationInput.value || "").trim();
    const notes = (addNotesInput.value || "").trim();

    if (!area || !point_number) {
      showError("Area and point are required.");
      return;
    }

    // Hard stop on duplicates (this is the whole reason we're doing this)
    const exists = allPoints.some(p => p.area === area && String(p.point_number) === String(point_number));
    if (exists) {
      openModal({
        title: "That point already exists",
        body: "This point is already on the list. Use “Edit existing set” or click “Treat now” in the table.",
        actions: [{ label:"OK", className:"btn btn-primary", onClick: closeModal }]
      });
      return;
    }

    isSaving = true;
    renderTable();

    const payload = {
      area,
      point_number,
      location: location || null,
      notes: notes || null
    };

    const { error } = await supabaseClient
      .from(TABLE_NAME)
      .insert(payload);

    if (error) {
      console.error(error);
      showError("Failed to add point. Check Supabase permissions and constraints.");
      isSaving = false;
      renderTable();
      return;
    }

    await loadData();
    isSaving = false;
    renderTable();

    // Auto-filter to that area for convenience
    currentAreaFilter = area;
    areaSelect.value = area;
    renderTable();

    hideManagePanels();
  }

  // Save edits to existing point (details only)
  async function onSaveExisting(event){
    event.preventDefault();
    if (isSaving) return;

    clearError();

    const val = editSelect.value;
    if (!val) {
      showError("Choose a point to edit.");
      return;
    }

    const [area, point_number] = val.split("||");
    const location = (editLocationInput.value || "").trim();
    const notes    = (editNotesInput.value || "").trim();

    isSaving = true;
    renderTable();

    const payload = {
      area,
      point_number,
      location: location || null,
      notes: notes || null
      // last_treated_at untouched
    };

    const { error } = await supabaseClient
      .from(TABLE_NAME)
      .upsert(payload, { onConflict: "area,point_number" });

    if (error) {
      console.error(error);
      showError("Failed to save changes. Check Supabase permissions (RLS) and constraints.");
      isSaving = false;
      renderTable();
      return;
    }

    await loadData();
    isSaving = false;
    renderTable();
    hideManagePanels();
  }

  // ===== Events =====
  areaSelect.addEventListener("change", () => {
    currentAreaFilter = areaSelect.value;
    renderTable();
  });
  
  managePointsBtn.addEventListener("click", openChooser);

  closeManageBtn1.addEventListener("click", () => hideManagePanels());
  closeManageBtn2.addEventListener("click", () => hideManagePanels());

  addNewForm.addEventListener("submit", onAddNew);
  editExistingForm.addEventListener("submit", onSaveExisting);
  editSelect.addEventListener("change", onEditSelectChange);
// ===== Initial load =====
  loadData();

  // Live refresh (background) every 10 seconds
  setInterval(() => {
    // Don’t refresh mid-save to avoid UI jitter / conflicts
    if (!isSaving) loadData(true);
  }, 10000);

</script>
</body>
</html>
